---
title: "DS 4002: Water Quality Final Presentation"
author: "Group 3: Stephanie Fissel, Beza Gashe, Claire Yoon"
date: "January 6, 2023"
output: 
  html_document:
    theme: yeti
    code_folding: hide
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 3
editor_options: 
chunk_output_type: inline
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(plotly)
library(shiny)
library(shinyWidgets)
library(tidyverse)
library(aod)
library(vtable)
library(scales)
library(reshape2)
library(gridExtra)
library(grid)
library(cowplot)
library(dplyr)
library(data.table)
library(e1071)
library(htmltools)
library(devtools)
library(caret)
library(NbClust)
library(randomForest)
library(rio)
library(plyr)
library(ROCR)
library(rpart)
library(psych)
library(pROC)
library(rpart.plot)
library(rattle)
library(class)
library(MLmetrics)
library(mltools)
library(RColorBrewer)
library(corrplot)
```

# **INTRODUCTION**
## Problem
Access to safe drinking water is essential to health and a basic human right, 
though many developing countries and even parts of the U.S. like Flint, Michigan are living with 
contaminated drinking water. With the increased prevalence of climate change, 
drinking water is becoming even more negatively impacted by contaminants. In 
these instances, non-potable drinking water containing unsafe levels of 
contaminants can have serious adverse health effects, such as gastrointestinal 
illnesses, cancer, and transmissible diseases. </br>

There are various water quality metrics that may contribute to the potability of
drinking water. We want to analyze and determine what metrics may more heavily 
contribute to water being non-potable which could, in the real world, help 
formulate effective policy for health protection through implementation of 
systems that specifically de-contaminate the water of these substances. In some 
regions, it has been shown that investments in water supply and sanitation can yield a new 
economic benefit, since the reductions in adverse health effects and health care 
costs outweigh the costs of undertaking the interventions. 

## Questions
* What is the distribution of each metric in regards to potable and non-potable water quality and can observations about water potability and selected metrics be made when other metrics are at varied levels?
* How well can machine learning models accurately predict the non-potability of water?

## Background Information
Water quality describes the condition of water and thus, to what extent it is safe for humans to utilize at different capacities (drinking, swimming, etc.). Understanding the quality of the water we drink is an integral component to protecting our health as well as the health of the environment. Contaminated water has been the root of numerous global health-related crises and lack of access to clean water in America, for example, can be further explained by the current structural and systematic racism embedded within society. <br>

771 million people (1 in 10) lack access to safe water. Approximately 829,000 individuals are predicted to die every year from diarrhea as a result of unsafe drinking water, poor hand hygiene, and poor sanitation. <br>

Current challenges to water supply systems include population growth, climate change, increasing water scarcity, demographic changes, and urbanization. The increasing rate of population growth contributes to the increased scarcity of clean water as the global human population reached 8 million in mid-November 2022. Additionally, the growing prevalence of climate change around the world is also affecting water access by disrupting water patterns and through the emergence of extreme weather events. For example, hotter, drier mountains leach more metal into water sources from abandoned mines and natural deposits, causing more acidified and contaminated drinking water. <br>

Reapplying this to the real world: <br>
- The Flint Water Crisis was a prime example of how our past responses and interventions during crises have shaped our current local, global, and national relationships between societies and people in the U.S. <br>
- Individuals and children in developing countries and low-income areas have to bear the burden of this crisis due to the avarices of those in positions of power. <br>
- Improving and optimizing water quality is a collective responsibility to work towards improving water sources for disproportionate areas while also addressing and eradicating health and racial disparities for both small communities such as Flint Michigan, American society, and the world at large. <br>

How water is cleaned: <br>
- In the U.S., water from surface and ground sources are treated to levels that meet state and federal standards for consumption by disinfecting and filtering the water or by meeting specific criteria for avoiding filtration so specific contaminants are controlled at certain levels. <br>
- The EPA established maximum contaminant levels for various contaminants [here](https://www.epa.gov/ground-water-and-drinking-water/national-primary-drinking-water-regulations). <br>
- Water from natural sources is treated for microorganisms, bacteria, toxic chemicals, viruses, and fecal matter.


# **EXPLORATORY DATA ANALYSIS**

## Dataset

#### ***[Water Quality](https://www.kaggle.com/datasets/adityakadiwal/water-potability?select=water_potability.csv)***
A dataset containing water quality metrics for 3276 different water bodies. <br/>

```{r}
# READ IN DATASET:
water_quality <- read.csv("/Users/stephaniefissel/Library/Mobile Documents/com~apple~CloudDocs/ds final project/water_potability.csv")
```


### Predictor Variables <br/>
    
* pH value
    + acidic or alkaline condition
* Hardness
    + caused by calcium and magnesium salts
* Solids (Total dissolved solids - TDS)
   + mineralization of organic minerals or salts
* Chloramines
   + disinfectant (chlorine + ammonia = chloramines)
* Sulfates
   + naturally occurring substance present in minerals, soil, and rocks
* Conductivity
   + determined by amount of dissolved solids
* Organic carbon
   + carbon in decaying natural organic matter and synthetic sources
* Trihalomethanes
   + chemicals found in water treated with chlorine
* Turbidity
   + depends on quantity of solid matter present; measure of light emitting 
   properties of water

### Target Variable <br/>

* Potability
   + indicator of whether water is safe for human consumption where 1 = Potable (good water) 
   and 0 = Not Potable (bad water)

## Data Cleaning

#### - Removed rows containing at least one NA
#### - Converting 'Potability' to a factor (categorical variable)
#### - 

### Prevalence of Variables
(table here)

### Initial Exploratory Data Analysis Visualizations
#### Distribution of the data between potable and non-potable
```{r}
# Initial Data Cleaning
water_quality <- na.omit(water_quality)
water_quality$Potability <- factor(water_quality$Potability)
# Find percentages
np <- round(1998/3276 * 100)
p <- round(1278/3276 * 100)
# Subset test data
data <- data.frame(
  category=c("Non-Potable", "Potable"),
  count=c(np, p)
)
# Compute percentages
data$fraction = data$count / sum(data$count)
# Compute the cumulative percentages (top of each rectangle)
data$ymax = cumsum(data$fraction)
# Compute the bottom of each rectangle
data$ymin = c(0, head(data$ymax, n=-1))
# Compute label position
data$labelPosition <- (data$ymax + data$ymin) / 2
# Compute a good label
data$label <- paste0(data$category, ": ", data$count, "%")
# Donut Chart
ggplot(data, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=category)) +
        geom_rect() +
        geom_label( x=3.5, aes(y=labelPosition, label=label), size=5) +
        scale_fill_manual(values = c("#E86363", "#63E871")) + 
        coord_polar(theta="y") +
        xlim(c(2, 4)) +
        theme_void() +
        theme(legend.position = "none")
```

#### Correlation Heatmap
##### Visualizes that there is low correlation between predictor variables
```{r}
# Initial Data Cleaning
water_quality <- na.omit(water_quality)
var <- names(water_quality) %in% c("Potability")
water_corr <- water_quality[!var]

# Correlation Heatmap
M <- cor(water_corr)
corrplot(M, method="color", col=colorRampPalette(c("white", "lightblue", "darkblue"))(100), tl.col = "black")
```


# **METHODS**
## Shiny App
method...

## Random Forest
method...

## Decision Tree
method...

# **RESULTS & EVALUATION**

## Interactive Shiny App

```{r}
water_quality <- na.omit(water_quality)
water_quality$Potability <- factor(water_quality$Potability)

np <- round(1998/3276 * 100)
p <- round(1278/3276 * 100)
# Subset test data
data <- data.frame(
  category=c("Non-Potable", "Potable"),
  count=c(np, p)
)

# Compute percentages
data$fraction = data$count / sum(data$count)

# Compute the cumulative percentages (top of each rectangle)
data$ymax = cumsum(data$fraction)

# Compute the bottom of each rectangle
data$ymin = c(0, head(data$ymax, n=-1))

# Compute label position
data$labelPosition <- (data$ymax + data$ymin) / 2

# Compute a good label
data$label <- paste0(data$category, ": ", data$count, "%")



shinyApp(
  ui <- fluidPage(
    titlePanel("METRIC DISTRIBUTIONS OF WATER POTABILITY"),
    br(),
    
    sidebarPanel(
      sliderInput("ph", "pH Level (pH):", min = 0, max = 14, value = c(0, 14), 
                step = 1),
      h6("Recommended Level: 6.5-8.5 pH (neutral on pH scale)"),
      sliderInput("hardness", "Hardness Level (mg/L):", min = 50, max = 360, value = c(50, 360), 
                step = 10),
      h6("Recommended Level: None. Hardness levels > 150 mg/L are considered hard water. If water is hard, it can reduce efficiency of water treatment."),
      sliderInput("solids", "Solids Level (mg/l):", min = 0, max = 50800, value = c(0, 50800), 
                step = 1000),
      h6("Recommended Level: 500-1000 mg/l"),
      sliderInput("chloramines", "Chloramine Level (mg/L):", min = 0, max = 14, value = c(0, 14), 
                step = 1),
      h6("Recommended Level: 4 mg/L or less"),
      sliderInput("sulfates", "Sulfate Level (mg/L):", min = 0, max = 500, value = c(0, 500), 
                step = 50),
      h6("Recommended Level: 250 mg/L or less"),
      sliderInput("conductivity", "Conductivity Level (μS/cm):", min = 200, max = 800, value = c(200, 800), 
                step = 100),
      h6("Recommended Level: 400 μS/cm or less"),
      sliderInput("organic_carbon", "Organic Carbon Level (mg/L):", min = 0, max = 30, value = c(0, 30), 
                step = 1),
      h6("Recommended Level: 2 mg/L or less"),
      sliderInput("trihalomethanes", "Trihalomethanes (ppm):", min = 0, max = 125, value = c(0, 125), 
                step = 10),
      h6("Recommended Level: 80 ppm or less"),
      sliderInput("turbidity", "Turbidity (NTU):", min = 0, max = 7, value = c(0, 7), 
                step = 1),
      h6("Recommended Level: 5 NTU or less"),
      width = 4
    ),
    
    mainPanel(
      
      tabsetPanel(type = "tabs",
                  tabPanel("Overall", plotOutput("overall"), width = "100%"),
                  tabPanel("pH", plotOutput("ph")),
                  tabPanel("Hardness", plotOutput("hardness")),
                  tabPanel("Solids", plotOutput("solids")),
                  tabPanel("Chloramines", plotOutput("chloramines")),
                  tabPanel("Sulfates", plotOutput("sulfates")),
                  tabPanel("Conductivity", plotOutput("conductivity")),
                  tabPanel("Organic Carbon", plotOutput("organic_carbon")),
                  tabPanel("Trihalomethanes", plotOutput("trihalomethanes")),
                  tabPanel("Turbidity", plotOutput("turbidity")),
                  ))
    ),
  
  server <- function(input, output) {
    
    output$overall <- renderPlot({
      
      ggplot(data, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=category)) +
        geom_rect() +
        geom_label( x=3.5, aes(y=labelPosition, label=label), size=5) +
        scale_fill_manual(values = c("#E86363", "#63E871")) + 
        coord_polar(theta="y") +
        xlim(c(2, 4)) +
        theme_void() +
        theme(legend.position = "none")
    }, height = 700, width = 900)
    
    output$ph <- renderPlot({
       water_quality <- filter(water_quality,
                              ph >= input$ph[1],
                              ph <= input$ph[2])
       water_quality <- filter(water_quality,
                              Hardness >= input$hardness[1],
                              Hardness <= input$hardness[2])
       water_quality <- filter(water_quality,
                              Solids >= input$solids[1],
                              Solids <= input$solids[2])
       water_quality <- filter(water_quality,
                              Chloramines >= input$chloramines[1],
                              Chloramines <= input$chloramines[2])
       water_quality <- filter(water_quality,
                              Sulfate >= input$sulfates[1],
                              Sulfate <= input$sulfates[2])
       water_quality <- filter(water_quality,
                              Conductivity >= input$conductivity[1],
                              Conductivity <= input$conductivity[2])
       water_quality <- filter(water_quality,
                              Organic_carbon >= input$organic_carbon[1],
                              Organic_carbon <= input$organic_carbon[2])
       water_quality <- filter(water_quality,
                              Trihalomethanes >= input$trihalomethanes[1],
                              Trihalomethanes <= input$trihalomethanes[2])
       water_quality <- filter(water_quality,
                              Turbidity >= input$turbidity[1],
                              Turbidity <= input$turbidity[2])
      
      nf <- layout( matrix(c(1,2), ncol=1))
      par(mar=c(0, 3.1, 1.1, 2.1))
      
      p1_1 <- ggplot(subset(water_quality, Potability %in% c("0")), aes(x=ph)) +
        geom_boxplot(fill="#E86363", alpha=0.7) +
        labs(x = " ") +
        theme_bw() +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.text.x = element_blank(),
              axis.text.y = element_blank(), axis.ticks.x = element_blank(), 
              axis.ticks.y = element_blank())
      
      p1_2 <- ggplot(subset(water_quality, Potability %in% c("1")), aes(x=ph)) +
        geom_boxplot(fill="#63E871", alpha=0.7) +
        labs(x = " ") +
        theme_bw() +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.text.x = element_blank(),
              axis.text.y = element_blank(), axis.ticks.x = element_blank(), 
              axis.ticks.y = element_blank())
      
      par(mar=c(4, 3.1, 1.1, 2.1))
      
      p2 <- ggplot(water_quality, aes(x = ph, color = Potability, fill=Potability)) + 
        geom_histogram(position= "identity", alpha = 0.4, bins=100) +
        scale_color_manual(values=c("#E86363", "#63E871"), guide = "none") +
        scale_fill_manual(values=c("#E86363", "#63E871"), labels = c("Non-Potable", "Potable")) +
        geom_vline(xintercept = 6.5, color = "darkslategrey", linetype = "dashed", size=0.3) + 
        geom_vline(xintercept = 8.5, color = "darkslategrey", linetype = "dashed", size=0.3) +
        labs(x = "pH Level (pH)", y = "Count") + 
        theme(text=element_text(size=15, family = "Helvetica"), legend.position=c(0.85, 0.5)) + 
        annotate("text", x = 5, y = 50, label = "< 6.5 is acidic") +
        annotate("text", x = 10, y = 50, label = "> 8.5 is basic") + 
        annotate("text", x = 7.5, y = 62, label = "recommended", size=3.2, color="darkslategrey") +
        annotate("text", x = 7.5, y = 60, label = "levels", size=3.2, color="darkslategrey")
      
      title <- ggdraw() + draw_label("pH Level Distribution", fontface='bold', size=20)
      plot_grid(title, p1_1, p1_2, p2, ncol=1, align="v", rel_heights = c(0.6, 0.8, 0.8, 6))
      })
      
    output$hardness <- renderPlot({
      water_quality <- filter(water_quality,
                              ph >= input$ph[1],
                              ph <= input$ph[2])
       water_quality <- filter(water_quality,
                              Hardness >= input$hardness[1],
                              Hardness <= input$hardness[2])
       water_quality <- filter(water_quality,
                              Solids >= input$solids[1],
                              Solids <= input$solids[2])
       water_quality <- filter(water_quality,
                              Chloramines >= input$chloramines[1],
                              Chloramines <= input$chloramines[2])
       water_quality <- filter(water_quality,
                              Sulfate >= input$sulfates[1],
                              Sulfate <= input$sulfates[2])
       water_quality <- filter(water_quality,
                              Conductivity >= input$conductivity[1],
                              Conductivity <= input$conductivity[2])
       water_quality <- filter(water_quality,
                              Organic_carbon >= input$organic_carbon[1],
                              Organic_carbon <= input$organic_carbon[2])
       water_quality <- filter(water_quality,
                              Trihalomethanes >= input$trihalomethanes[1],
                              Trihalomethanes <= input$trihalomethanes[2])
       water_quality <- filter(water_quality,
                              Turbidity >= input$turbidity[1],
                              Turbidity <= input$turbidity[2])
      
      nf <- layout( matrix(c(1,2), ncol=1))
      par(mar=c(0, 3.1, 1.1, 2.1))
      
      p1_1 <- ggplot(subset(water_quality, Potability %in% c("0")), aes(x=Hardness)) +
        geom_boxplot(fill="#E86363", alpha=0.7) +
        labs(x = " ") +
        theme_bw() +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.text.x = element_blank(),
              axis.text.y = element_blank(), axis.ticks.x = element_blank(), 
              axis.ticks.y = element_blank())
      
      p1_2 <- ggplot(subset(water_quality, Potability %in% c("1")), aes(x=Hardness)) +
        geom_boxplot(fill="#63E871", alpha=0.7) +
        labs(x = " ") +
        theme_bw() +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.text.x = element_blank(),
              axis.text.y = element_blank(), axis.ticks.x = element_blank(), 
              axis.ticks.y = element_blank())
      
      par(mar=c(4, 3.1, 1.1, 2.1))
      
      p2 <- ggplot(water_quality, aes(x = Hardness, color = Potability, fill=Potability)) + 
        geom_histogram(position= "identity", alpha = 0.4, bins=100) +
        scale_color_manual(values=c("#E86363", "#63E871"), guide = "none") +
        scale_fill_manual(values=c("#E86363", "#63E871"), labels = c("Non-Potable", "Potable")) +
        geom_vline(xintercept = 75, color = "darkslategrey", linetype = "dashed", size=0.3) + 
        geom_vline(xintercept = 150, color = "darkslategrey", linetype = "dashed", size=0.3) + 
        geom_vline(xintercept = 300, color = "darkslategrey", linetype = "dashed", size=0.3) + 
        labs(x = "Hardness Level (mg/L)", y = "Count") + 
        theme(text=element_text(size=15, family = "Helvetica"), legend.position=c(0.85, 0.5)) + 
        annotate("text", x = 75, y = 45, label = "< 75 is soft") +
        annotate("text", x = 110, y = 50, label = "> 75 is moderately hard") +
        annotate("text", x = 170, y = 50, label = "> 150 is hard") +
        annotate("text", x = 305, y = 50, label = "> 300 is very hard")
      
      title <- ggdraw() + draw_label("Hardness Level Distribution", fontface='bold', size=20)
      plot_grid(title, p1_1, p1_2, p2, ncol=1, align="v", rel_heights = c(0.6, 0.8, 0.8, 6))
    })
    
    output$solids <- renderPlot({
      water_quality <- filter(water_quality,
                              ph >= input$ph[1],
                              ph <= input$ph[2])
       water_quality <- filter(water_quality,
                              Hardness >= input$hardness[1],
                              Hardness <= input$hardness[2])
       water_quality <- filter(water_quality,
                              Solids >= input$solids[1],
                              Solids <= input$solids[2])
       water_quality <- filter(water_quality,
                              Chloramines >= input$chloramines[1],
                              Chloramines <= input$chloramines[2])
       water_quality <- filter(water_quality,
                              Sulfate >= input$sulfates[1],
                              Sulfate <= input$sulfates[2])
       water_quality <- filter(water_quality,
                              Conductivity >= input$conductivity[1],
                              Conductivity <= input$conductivity[2])
       water_quality <- filter(water_quality,
                              Organic_carbon >= input$organic_carbon[1],
                              Organic_carbon <= input$organic_carbon[2])
       water_quality <- filter(water_quality,
                              Trihalomethanes >= input$trihalomethanes[1],
                              Trihalomethanes <= input$trihalomethanes[2])
       water_quality <- filter(water_quality,
                              Turbidity >= input$turbidity[1],
                              Turbidity <= input$turbidity[2])
      
      nf <- layout( matrix(c(1,2), ncol=1))
      par(mar=c(0, 3.1, 1.1, 2.1))
      
      p1_1 <- ggplot(subset(water_quality, Potability %in% c("0")), aes(x=Solids)) +
        geom_boxplot(fill="#E86363", alpha=0.7) +
        labs(x = " ") +
        theme_bw() +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.text.x = element_blank(),
              axis.text.y = element_blank(), axis.ticks.x = element_blank(), 
              axis.ticks.y = element_blank())
      
      p1_2 <- ggplot(subset(water_quality, Potability %in% c("1")), aes(x=Solids)) +
        geom_boxplot(fill="#63E871", alpha=0.7) +
        labs(x = " ") +
        theme_bw() +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.text.x = element_blank(),
              axis.text.y = element_blank(), axis.ticks.x = element_blank(), 
              axis.ticks.y = element_blank())
      
      par(mar=c(4, 3.1, 1.1, 2.1))
      
      p2 <- ggplot(water_quality, aes(x = Solids, color = Potability, fill=Potability)) + 
        geom_histogram(position= "identity", alpha = 0.4, bins=100) +
        scale_color_manual(values=c("#E86363", "#63E871"), guide = "none") +
        scale_fill_manual(values=c("#E86363", "#63E871"), labels = c("Non-Potable", "Potable")) +
        geom_vline(xintercept = 500, color = "darkslategrey", linetype = "dashed", size=0.3) + 
        geom_vline(xintercept = 1000, color = "darkslategrey", linetype = "dashed", size=0.3) +
        labs(x = "Solid Level (mg/l)", y = "Count") + 
        theme(text=element_text(size=15, family = "Helvetica"), legend.position=c(0.85, 0.5)) + 
        annotate("text", x = 6000, y = 50, label = "> 1000 is high") + 
        annotate("text", x = 800, y = 62, label = "recommended", size=3.2, color="darkslategrey") +
        annotate("text", x = 800, y = 60, label = "levels", size=3.2, color="darkslategrey")
      
      title <- ggdraw() + draw_label("Solid Level Distribution", fontface='bold', size=20)
      plot_grid(title, p1_1, p1_2, p2, ncol=1, align="v", rel_heights = c(0.6, 0.8, 0.8, 6))
    })
    
    output$chloramines <- renderPlot({
      water_quality <- filter(water_quality,
                              ph >= input$ph[1],
                              ph <= input$ph[2])
       water_quality <- filter(water_quality,
                              Hardness >= input$hardness[1],
                              Hardness <= input$hardness[2])
       water_quality <- filter(water_quality,
                              Solids >= input$solids[1],
                              Solids <= input$solids[2])
       water_quality <- filter(water_quality,
                              Chloramines >= input$chloramines[1],
                              Chloramines <= input$chloramines[2])
       water_quality <- filter(water_quality,
                              Sulfate >= input$sulfates[1],
                              Sulfate <= input$sulfates[2])
       water_quality <- filter(water_quality,
                              Conductivity >= input$conductivity[1],
                              Conductivity <= input$conductivity[2])
       water_quality <- filter(water_quality,
                              Organic_carbon >= input$organic_carbon[1],
                              Organic_carbon <= input$organic_carbon[2])
       water_quality <- filter(water_quality,
                              Trihalomethanes >= input$trihalomethanes[1],
                              Trihalomethanes <= input$trihalomethanes[2])
       water_quality <- filter(water_quality,
                              Turbidity >= input$turbidity[1],
                              Turbidity <= input$turbidity[2])
      
      nf <- layout( matrix(c(1,2), ncol=1))
      par(mar=c(0, 3.1, 1.1, 2.1))
      
      p1_1 <- ggplot(subset(water_quality, Potability %in% c("0")), aes(x=Chloramines)) +
        geom_boxplot(fill="#E86363", alpha=0.7) +
        labs(x = " ") +
        theme_bw() +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.text.x = element_blank(),
              axis.text.y = element_blank(), axis.ticks.x = element_blank(), 
              axis.ticks.y = element_blank())
      
      p1_2 <- ggplot(subset(water_quality, Potability %in% c("1")), aes(x=Chloramines)) +
        geom_boxplot(fill="#63E871", alpha=0.7) +
        labs(x = " ") +
        theme_bw() +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.text.x = element_blank(),
              axis.text.y = element_blank(), axis.ticks.x = element_blank(), 
              axis.ticks.y = element_blank())
      
      par(mar=c(4, 3.1, 1.1, 2.1))
      
      p2 <- ggplot(water_quality, aes(x = Chloramines, color = Potability, fill=Potability)) + 
        geom_histogram(position= "identity", alpha = 0.4, bins=100) +
        scale_color_manual(values=c("#E86363", "#63E871"), guide = "none") +
        scale_fill_manual(values=c("#E86363", "#63E871"), labels = c("Non-Potable", "Potable")) +
        geom_vline(xintercept = 4, color = "darkslategrey", linetype = "dashed", size=0.3) + 
        labs(x = "Chloramine Level (mg/L)", y = "Count") + 
        theme(text=element_text(size=15, family = "Helvetica"), legend.position=c(0.85, 0.5)) + 
        annotate("text", x = 4.8, y = 45, label = "> 4 is high") +
        annotate("text", x = 4, y = 55, label = "recommended", size=3.2, color="darkslategrey") +
        annotate("text", x = 4, y = 53, label = "threshold", size=3.2, color="darkslategrey")
      
      title <- ggdraw() + draw_label("Chloramine Level Distribution", fontface='bold', size=20)
      plot_grid(title, p1_1, p1_2, p2, ncol=1, align="v", rel_heights = c(0.6, 0.8, 0.8, 6))
    })
    
    output$sulfates <- renderPlot({
      water_quality <- filter(water_quality,
                              ph >= input$ph[1],
                              ph <= input$ph[2])
       water_quality <- filter(water_quality,
                              Hardness >= input$hardness[1],
                              Hardness <= input$hardness[2])
       water_quality <- filter(water_quality,
                              Solids >= input$solids[1],
                              Solids <= input$solids[2])
       water_quality <- filter(water_quality,
                              Chloramines >= input$chloramines[1],
                              Chloramines <= input$chloramines[2])
       water_quality <- filter(water_quality,
                              Sulfate >= input$sulfates[1],
                              Sulfate <= input$sulfates[2])
       water_quality <- filter(water_quality,
                              Conductivity >= input$conductivity[1],
                              Conductivity <= input$conductivity[2])
       water_quality <- filter(water_quality,
                              Organic_carbon >= input$organic_carbon[1],
                              Organic_carbon <= input$organic_carbon[2])
       water_quality <- filter(water_quality,
                              Trihalomethanes >= input$trihalomethanes[1],
                              Trihalomethanes <= input$trihalomethanes[2])
       water_quality <- filter(water_quality,
                              Turbidity >= input$turbidity[1],
                              Turbidity <= input$turbidity[2])
      
      nf <- layout( matrix(c(1,2), ncol=1))
      par(mar=c(0, 3.1, 1.1, 2.1))
      
      p1_1 <- ggplot(subset(water_quality, Potability %in% c("0")), aes(x=Sulfate)) +
        geom_boxplot(fill="#E86363", alpha=0.7) +
        labs(x = " ") +
        theme_bw() +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.text.x = element_blank(),
              axis.text.y = element_blank(), axis.ticks.x = element_blank(), 
              axis.ticks.y = element_blank())
      
      p1_2 <- ggplot(subset(water_quality, Potability %in% c("1")), aes(x=Sulfate)) +
        geom_boxplot(fill="#63E871", alpha=0.7) +
        labs(x = " ") +
        theme_bw() +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.text.x = element_blank(),
              axis.text.y = element_blank(), axis.ticks.x = element_blank(), 
              axis.ticks.y = element_blank())
      
      par(mar=c(4, 3.1, 1.1, 2.1))
      
      p2 <- ggplot(water_quality, aes(x = Sulfate, color = Potability, fill=Potability)) + 
        geom_histogram(position= "identity", alpha = 0.4, bins=100) +
        scale_color_manual(values=c("#E86363", "#63E871"), guide = "none") +
        scale_fill_manual(values=c("#E86363", "#63E871"), labels = c("Non-Potable", "Potable")) +
        geom_vline(xintercept = 250, color = "darkslategrey", linetype = "dashed", size=0.3) + 
        labs(x = "Sulfate Level (mg/L)", y = "Count") + 
        theme(text=element_text(size=15, family = "Helvetica"), legend.position=c(0.92, 0.5)) + 
        annotate("text", x = 275, y = 50, label = "> 250 is high") +
        annotate("text", x = 250, y = 38, label = "recommended", size=3.2, color="darkslategrey") +
        annotate("text", x = 250, y = 36, label = "threshold", size=3.2, color="darkslategrey")
      
      title <- ggdraw() + draw_label("Sulfate Level Distribution", fontface='bold', size=20)
      plot_grid(title, p1_1, p1_2, p2, ncol=1, align="v", rel_heights = c(0.6, 0.8, 0.8, 6))
    })
    
    output$conductivity <- renderPlot({
      water_quality <- filter(water_quality,
                              ph >= input$ph[1],
                              ph <= input$ph[2])
       water_quality <- filter(water_quality,
                              Hardness >= input$hardness[1],
                              Hardness <= input$hardness[2])
       water_quality <- filter(water_quality,
                              Solids >= input$solids[1],
                              Solids <= input$solids[2])
       water_quality <- filter(water_quality,
                              Chloramines >= input$chloramines[1],
                              Chloramines <= input$chloramines[2])
       water_quality <- filter(water_quality,
                              Sulfate >= input$sulfates[1],
                              Sulfate <= input$sulfates[2])
       water_quality <- filter(water_quality,
                              Conductivity >= input$conductivity[1],
                              Conductivity <= input$conductivity[2])
       water_quality <- filter(water_quality,
                              Organic_carbon >= input$organic_carbon[1],
                              Organic_carbon <= input$organic_carbon[2])
       water_quality <- filter(water_quality,
                              Trihalomethanes >= input$trihalomethanes[1],
                              Trihalomethanes <= input$trihalomethanes[2])
       water_quality <- filter(water_quality,
                              Turbidity >= input$turbidity[1],
                              Turbidity <= input$turbidity[2])
      
      nf <- layout( matrix(c(1,2), ncol=1))
      par(mar=c(0, 3.1, 1.1, 2.1))
      
      p1_1 <- ggplot(subset(water_quality, Potability %in% c("0")), aes(x=Conductivity)) +
        geom_boxplot(fill="#E86363", alpha=0.7) +
        labs(x = " ") +
        theme_bw() +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.text.x = element_blank(),
              axis.text.y = element_blank(), axis.ticks.x = element_blank(), 
              axis.ticks.y = element_blank())
      
      p1_2 <- ggplot(subset(water_quality, Potability %in% c("1")), aes(Conductivity)) +
        geom_boxplot(fill="#63E871", alpha=0.7) +
        labs(x = " ") +
        theme_bw() +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.text.x = element_blank(),
              axis.text.y = element_blank(), axis.ticks.x = element_blank(), 
              axis.ticks.y = element_blank())
      
      par(mar=c(4, 3.1, 1.1, 2.1))
      
      p2 <- ggplot(water_quality, aes(x = Conductivity, color = Potability, fill=Potability)) + 
        geom_histogram(position= "identity", alpha = 0.4, bins=100) +
        scale_color_manual(values=c("#E86363", "#63E871"), guide = "none") +
        scale_fill_manual(values=c("#E86363", "#63E871"), labels = c("Non-Potable", "Potable")) +
        geom_vline(xintercept = 400, color = "darkslategrey", linetype = "dashed", size=0.3) + 
        labs(x = "Conductivity Level (μS/cm)", y = "Count") + 
        theme(text=element_text(size=15, family = "Helvetica"), legend.position=c(0.85, 0.5)) + 
        annotate("text", x = 460, y = 42, label = "> 400 is high") +
        annotate("text", x = 400, y = 47, label = "recommended", size=3.2, color="darkslategrey") +
        annotate("text", x = 400, y = 45, label = "threshold", size=3.2, color="darkslategrey")
      
      title <- ggdraw() + draw_label("Conductivity Level Distribution", fontface='bold', size=20)
      plot_grid(title, p1_1, p1_2, p2, ncol=1, align="v", rel_heights = c(0.6, 0.8, 0.8, 6))
    })
    
    output$organic_carbon <- renderPlot({
      water_quality <- filter(water_quality,
                              ph >= input$ph[1],
                              ph <= input$ph[2])
       water_quality <- filter(water_quality,
                              Hardness >= input$hardness[1],
                              Hardness <= input$hardness[2])
       water_quality <- filter(water_quality,
                              Solids >= input$solids[1],
                              Solids <= input$solids[2])
       water_quality <- filter(water_quality,
                              Chloramines >= input$chloramines[1],
                              Chloramines <= input$chloramines[2])
       water_quality <- filter(water_quality,
                              Sulfate >= input$sulfates[1],
                              Sulfate <= input$sulfates[2])
       water_quality <- filter(water_quality,
                              Conductivity >= input$conductivity[1],
                              Conductivity <= input$conductivity[2])
       water_quality <- filter(water_quality,
                              Organic_carbon >= input$organic_carbon[1],
                              Organic_carbon <= input$organic_carbon[2])
       water_quality <- filter(water_quality,
                              Trihalomethanes >= input$trihalomethanes[1],
                              Trihalomethanes <= input$trihalomethanes[2])
       water_quality <- filter(water_quality,
                              Turbidity >= input$turbidity[1],
                              Turbidity <= input$turbidity[2])
      
      nf <- layout( matrix(c(1,2), ncol=1))
      par(mar=c(0, 3.1, 1.1, 2.1))
      
      p1_1 <- ggplot(subset(water_quality, Potability %in% c("0")), aes(x=Organic_carbon)) +
        geom_boxplot(fill="#E86363", alpha=0.7) +
        labs(x = " ") +
        theme_bw() +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.text.x = element_blank(),
              axis.text.y = element_blank(), axis.ticks.x = element_blank(), 
              axis.ticks.y = element_blank())
      
      p1_2 <- ggplot(subset(water_quality, Potability %in% c("1")), aes(x=Organic_carbon)) +
        geom_boxplot(fill="#63E871", alpha=0.7) +
        labs(x = " ") +
        theme_bw() +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.text.x = element_blank(),
              axis.text.y = element_blank(), axis.ticks.x = element_blank(), 
              axis.ticks.y = element_blank())
      
      par(mar=c(4, 3.1, 1.1, 2.1))
      
      p2 <- ggplot(water_quality, aes(x = Organic_carbon, color = Potability, fill=Potability)) + 
        geom_histogram(position= "identity", alpha = 0.4, bins=100) +
        scale_color_manual(values=c("#E86363", "#63E871"), guide = "none") +
        scale_fill_manual(values=c("#E86363", "#63E871"), labels = c("Non-Potable", "Potable")) +
        geom_vline(xintercept = 2, color = "darkslategrey", linetype = "dashed", size=0.3) + 
        labs(x = "Organic Carbon Level (mg/L)", y = "Count") + 
        theme(text=element_text(size=15, family = "Helvetica"), legend.position=c(0.85, 0.5)) + 
        annotate("text", x = 4, y = 35, label = "> 2 is high") + 
        annotate("text", x = 2.5, y = 43, label = "recommended", size=3.2, color="darkslategrey") +
        annotate("text", x = 2.5, y = 41, label = "threshold", size=3.2, color="darkslategrey")
      
      title <- ggdraw() + draw_label("Organic Carbon Level Distribution", fontface='bold', size=20)
      plot_grid(title, p1_1, p1_2, p2, ncol=1, align="v", rel_heights = c(0.6, 0.8, 0.8, 6))
    })
    
    output$trihalomethanes <- renderPlot({
      water_quality <- filter(water_quality,
                              ph >= input$ph[1],
                              ph <= input$ph[2])
       water_quality <- filter(water_quality,
                              Hardness >= input$hardness[1],
                              Hardness <= input$hardness[2])
       water_quality <- filter(water_quality,
                              Solids >= input$solids[1],
                              Solids <= input$solids[2])
       water_quality <- filter(water_quality,
                              Chloramines >= input$chloramines[1],
                              Chloramines <= input$chloramines[2])
       water_quality <- filter(water_quality,
                              Sulfate >= input$sulfates[1],
                              Sulfate <= input$sulfates[2])
       water_quality <- filter(water_quality,
                              Conductivity >= input$conductivity[1],
                              Conductivity <= input$conductivity[2])
       water_quality <- filter(water_quality,
                              Organic_carbon >= input$organic_carbon[1],
                              Organic_carbon <= input$organic_carbon[2])
       water_quality <- filter(water_quality,
                              Trihalomethanes >= input$trihalomethanes[1],
                              Trihalomethanes <= input$trihalomethanes[2])
       water_quality <- filter(water_quality,
                              Turbidity >= input$turbidity[1],
                              Turbidity <= input$turbidity[2])
      
      nf <- layout( matrix(c(1,2), ncol=1))
      par(mar=c(0, 3.1, 1.1, 2.1))
      
      p1_1 <- ggplot(subset(water_quality, Potability %in% c("0")), aes(x=Trihalomethanes)) +
        geom_boxplot(fill="#E86363", alpha=0.7) +
        labs(x = " ") +
        theme_bw() +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.text.x = element_blank(),
              axis.text.y = element_blank(), axis.ticks.x = element_blank(), 
              axis.ticks.y = element_blank())
      
      p1_2 <- ggplot(subset(water_quality, Potability %in% c("1")), aes(x=Trihalomethanes)) +
        geom_boxplot(fill="#63E871", alpha=0.7) +
        labs(x = " ") +
        theme_bw() +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.text.x = element_blank(),
              axis.text.y = element_blank(), axis.ticks.x = element_blank(), 
              axis.ticks.y = element_blank())
      
      par(mar=c(4, 3.1, 1.1, 2.1))
      
      p2 <- ggplot(water_quality, aes(x = Trihalomethanes, color = Potability, fill=Potability)) + 
        geom_histogram(position= "identity", alpha = 0.4, bins=100) +
        scale_color_manual(values=c("#E86363", "#63E871"), guide = "none") +
        scale_fill_manual(values=c("#E86363", "#63E871"), labels = c("Non-Potable", "Potable")) +
        geom_vline(xintercept = 80, color = "darkslategrey", linetype = "dashed", size=0.3) + 
        labs(x = "Trihalomethanes Level (ppm)", y = "Count") + 
        theme(text=element_text(size=15, family = "Helvetica"), legend.position=c(0.85, 0.5)) + 
        annotate("text", x = 90, y = 40, label = "> 80 is high") +
        annotate("text", x = 80, y = 47, label = "recommended", size=3.2, color="darkslategrey") +
        annotate("text", x = 80, y = 45, label = "threshold", size=3.2, color="darkslategrey")
      
      title <- ggdraw() + draw_label("Trihalomethanes Level Distribution", fontface='bold', size=20)
      plot_grid(title, p1_1, p1_2, p2, ncol=1, align="v", rel_heights = c(0.6, 0.8, 0.8, 6))
    })
    
    output$turbidity <- renderPlot({
      water_quality <- filter(water_quality,
                              ph >= input$ph[1],
                              ph <= input$ph[2])
       water_quality <- filter(water_quality,
                              Hardness >= input$hardness[1],
                              Hardness <= input$hardness[2])
       water_quality <- filter(water_quality,
                              Solids >= input$solids[1],
                              Solids <= input$solids[2])
       water_quality <- filter(water_quality,
                              Chloramines >= input$chloramines[1],
                              Chloramines <= input$chloramines[2])
       water_quality <- filter(water_quality,
                              Sulfate >= input$sulfates[1],
                              Sulfate <= input$sulfates[2])
       water_quality <- filter(water_quality,
                              Conductivity >= input$conductivity[1],
                              Conductivity <= input$conductivity[2])
       water_quality <- filter(water_quality,
                              Organic_carbon >= input$organic_carbon[1],
                              Organic_carbon <= input$organic_carbon[2])
       water_quality <- filter(water_quality,
                              Trihalomethanes >= input$trihalomethanes[1],
                              Trihalomethanes <= input$trihalomethanes[2])
       water_quality <- filter(water_quality,
                              Turbidity >= input$turbidity[1],
                              Turbidity <= input$turbidity[2])
      
      nf <- layout( matrix(c(1,2), ncol=1))
      par(mar=c(0, 3.1, 1.1, 2.1))
      
      p1_1 <- ggplot(subset(water_quality, Potability %in% c("0")), aes(x=Turbidity)) +
        geom_boxplot(fill="#E86363", alpha=0.7) +
        labs(x = " ") +
        theme_bw() +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.text.x = element_blank(),
              axis.text.y = element_blank(), axis.ticks.x = element_blank(), 
              axis.ticks.y = element_blank())
      
      p1_2 <- ggplot(subset(water_quality, Potability %in% c("1")), aes(x=Turbidity)) +
        geom_boxplot(fill="#63E871", alpha=0.7) +
        labs(x = " ") +
        theme_bw() +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), axis.text.x = element_blank(),
              axis.text.y = element_blank(), axis.ticks.x = element_blank(), 
              axis.ticks.y = element_blank())
      
      par(mar=c(4, 3.1, 1.1, 2.1))
      
      p2 <- ggplot(water_quality, aes(x = Turbidity, color = Potability, fill=Potability)) + 
        geom_histogram(position= "identity", alpha = 0.4, bins=100) +
        scale_color_manual(values=c("#E86363", "#63E871"), guide = "none") +
        scale_fill_manual(values=c("#E86363", "#63E871"), labels = c("Non-Potable", "Potable")) +
        geom_vline(xintercept = 5, color = "darkslategrey", linetype = "dashed", size=0.3) + 
        labs(x = "Turbidity Level (NTU)", y = "Count") + 
        theme(text=element_text(size=15, family = "Helvetica"), legend.position=c(0.85, 0.5)) + 
        annotate("text", x = 5.4, y = 37, label = "> 5 is high") +
        annotate("text", x = 5, y = 45, label = "recommended", size=3.2, color="darkslategrey") +
        annotate("text", x = 5, y = 43, label = "threshold", size=3.2, color="darkslategrey")
      
      title <- ggdraw() + draw_label("Turbidity Level Distribution", fontface='bold', size=20)
      plot_grid(title, p1_1, p1_2, p2, ncol=1, align="v", rel_heights = c(0.6, 0.8, 0.8, 6))
    })
    
    })
```

### Evaluation of Shiny App:
(Evaluation of Shiny App)

## Random Forest
(code- dropdown section)

#### Threshold: ?

### Variable Importance
(Table)

(Visualized model)

(Possible statistics table)

### Random Forest Evaluation:
(Random Forest Evaluation...)

## Decision Tree
(code- dropdown section)

#### Threshold: ?

### Variable Importance
(Table)

(Visualized model)

(Possible statistics table)

### Decision Tree Evaluation:
(Decision Tree Evaluation...)

## Variable Importance by Model
(Table)

## Metrics by Model
(Table)

## Accuracy Increase Over Span of Project
(Table)

# **CONCLUSIONS**
We were trying to increase the accuracy of models on Decision Tree and Random Forest, but at most, the accuracy we were able to reach was around 68%. For the decision tree, we tried different methods such as C5.0 and LGOCV (Leave Group Out Cross Validation) besides rpart2, but the best fit was the rpart2 method considering the overall quality of the model. 

# **FUTURE WORK**
* Do more research involving geographical data to implement as another factor of water quality (climate change, agriculture, etc.)
* Figure out how to connect the shiny app to the existing machine learning models
* Look at a bigger size of data or any related data that we can combine/merge so that allows us to train the models and predict with better accuracy

# **SOURCES**
* https://www.kaggle.com/datasets/adityakadiwal/water-potability
* https://www.who.int/news-room/fact-sheets/detail/drinking-water
* https://www.scientificamerican.com/article/climate-change-is-acidifying-and-contaminating-drinking-water-and-alpine-ecosystems/
* https://www.watereducation.org/aquapedia-background/potable-water
* https://www.epa.gov/ground-water-and-drinking-water/national-primary-drinking-water-regulations

